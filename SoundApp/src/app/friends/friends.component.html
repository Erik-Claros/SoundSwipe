<app-back-button></app-back-button>

<!-- Button to show input box -->
<button mat-raised-button color="primary" (click)="showInputBox()">Find Friends!</button>

<!-- Input Box for Searching Friends -->
<div *ngIf="isInputVisible" style="margin-top: 10px;">
  <mat-form-field appearance="fill">
    <mat-label>Email</mat-label>
    <input 
      matInput 
      [(ngModel)]="userInput" 
      (keydown)="handleInput($event)" 
      placeholder="Type something and press Enter" 
    />
    <mat-icon matSuffix *ngIf="userInput" (click)="userInput=''">clear</mat-icon>
  </mat-form-field>
</div>

<!-- Display User Info when Found -->
<div *ngIf="userInput" style="margin-top: 10px;">
  <mat-card>
    <mat-card-header>
      <mat-card-title>User Information</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <ng-container *ngIf="userSearchFriend; else noFriendFound">
        <p><strong>First Name:</strong> {{ userSearchFriend.firstName }}</p>
        <p><strong>Last Name:</strong> {{ userSearchFriend.lastName }}</p>
        <p><strong>Email:</strong> {{ userSearchFriend.email }}</p>

        <!-- Already friends section -->
        <div *ngIf="isAlreadyFriends(userSearchFriend.email)">
          <p style="color: green;">
            <strong>This user is already your friend!</strong>
          </p>
        </div>

        <button mat-raised-button color="primary" (click)="addFriendRequest(userSearchFriend)" 
          *ngIf="!isAlreadyFriends(userSearchFriend.email)">
          Add Friend
        </button>
      </ng-container>
      <ng-template #noFriendFound>
        <p>No user found with this email.</p>
      </ng-template>
    </mat-card-content>
  </mat-card>
</div>

<!-- Users Table Layout (Left Side of the Screen) -->
<div class="users-table-container">

  <!-- Table of Friends on the Left -->
  <div class="friends-table">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Your Friends</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="userFriends">
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef> Name </th>
            <td mat-cell *matCellDef="let friend">
              {{ friend.firstName }} {{ friend.lastName }}
            </td>
          </ng-container>
          
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef> Email </th>
            <td mat-cell *matCellDef="let friend">
              {{ friend.email }}
            </td>
          </ng-container>

          <ng-container matColumnDef="chat">
            <th mat-header-cell *matHeaderCellDef> Chat </th>
            <td mat-cell *matCellDef="let friend">
              <button mat-icon-button (click)="loadChatLog(friend)">
                <mat-icon color="primary">chat</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Chat Card on the Right (Displayed When a Chat is Opened) -->
  <div *ngIf="selectedFriend" class="chat-card">
    <mat-card>
      <mat-card-header>
        <mat-card-title>{{ selectedFriend.firstName }} {{ selectedFriend.lastName }}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <!-- Chat Log -->
        <div class="chat-log">
          <div *ngFor="let message of chatLog" [ngClass]="{
            'sent-message': message.senderId === 'userId', 
            'received-message': message.senderId !== 'userId'
          }">
          <strong>{{ message.senderId }}:</strong> {{ message.songId }}
          </div>
        </div>
        
        <!-- Message Input Area -->
        <!-- Commented out as per your code structure, but you can re-enable it as needed -->
        <!-- <mat-form-field appearance="fill" style="width: 100%; margin-top: 10px;">
          <mat-label>Type a message</mat-label>
          <textarea matInput [(ngModel)]="input" rows="2"></textarea>
        </mat-form-field>
        
        <button mat-raised-button color="primary" (click)="sendMessage()" [disabled]="!input">Send</button> -->
      </mat-card-content>
    </mat-card>
  </div>
</div>

<!-- If No Friends Added Yet -->
<div *ngIf="userFriends.length === 0" style="margin-top: 20px;">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Your Friends</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p>No friends added yet.</p>
    </mat-card-content>
  </mat-card>
</div>

<app-back-to-top></app-back-to-top>
